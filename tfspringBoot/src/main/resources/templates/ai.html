<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>MQTT Client Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="height=device-height">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    div {
      width: 100%;
      height: 100%;
    }
    img#cameraView {
      max-width: 50%;
      max-height: 50%;
      bottom: 0;
      left: 0;
      right: 0;
      top: 0;
      margin: auto;
      overflow: auto;
      position: fixed;
    }
  </style>
</head>
<body>
<h1>MQTT Client Example</h1>
<div align="center">
  <img id="cameraView" width="80%" height="80%">
</div>

<!-- result 값 나오는 곳-->
<div id="result" style="text-align: center; margin-top: 20px;">
<h2>결과 : </h2>
  <p id="resultText"> 데이터 기다리는 중. . . </p>
</div>

<script type="text/javascript">
  const broker = 'ws://파이썬 Server IP:9001';
  const topic = 'cam/objects';

  const client = mqtt.connect(broker);

  client.on("connect", () => {
    console.log("브로커 연결 성공");
    client.subscribe(topic, (err) => {
      if(!err) {
        console.log(`토픽 구독 : ${topic}`);
      }
    })
  })

  client.on("message", (topic, message) => {
    try{
      const payload = JSON.parse(message.toString());
      const base64Image = payload.image;
      const img = document.getElementById("cameraView")
      img.src = `data:image/jpg;base64,${base64Image}`;

    document.getElementById("resultText").innerText = payload.result || "결과 없음";  // result에 결과 값 표시
    }catch(e) {
      console.error('Failed to parse message: ', e);
    }
  })

  client.on("error", (error) => {
    console.error("연결 오류 : ", error);
  })

  client.on("close", ()=> {
    console.log("브로커와 연결되지 않습니다. 담당자에게 확인하세요.");
  })
</script>
</body>
</html>