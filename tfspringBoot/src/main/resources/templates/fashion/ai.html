<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>실시간 의류 영상 스트리밍</title>
  <meta charset="utf-8">
  <meta name="viewport" content="height=device-height">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/footer.css">
  <style>
    .stream-container {
        width: 100%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        background-color: #f8f9fa;
    }

    .video-wrapper {
        width: 80%;
        max-width: 1200px;
        margin: 20px auto;
        position: relative;
        aspect-ratio: 16 / 9;
        background-color: #000;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #cameraView {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
    }

    .controls {
        margin: 20px 0;
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .result-section {
        width: 80%;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #resultText {
        font-size: 1.2rem;
        color: #333;
        margin: 10px 0;
    }

    .btn-primary {
        background-color: #4CAF50;
        border-color: #4CAF50;
    }

    .btn-danger {
        background-color: #f44336;
        border-color: #f44336;
    }
  </style>
</head>
<body>
<div th:replace="~{common/header :: header}"></div>

<div class="stream-container">
  <div class="video-wrapper">
    <img id="cameraView" alt="Video Stream">
  </div>

  <div class="controls">
    <button id="startBtn" class="btn btn-primary">Start</button>
    <button id="stopBtn" class="btn btn-danger" disabled>Stop</button>
  </div>

  <div class="result-section">
    <h2>탐지 결과</h2>
    <p id="resultText">데이터 기다리는 중...</p>
  </div>
</div>

<!-- 온도 설정 모달 -->
<div class="modal fade" id="temperatureModal" tabindex="-1" aria-labelledby="temperatureModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="temperatureModalLabel">온도 설정</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="recommended-temp mb-4">
          <h6>추천 온도</h6>
          <div class="temp-display">
            <span id="recommendedTemp">20</span>°C
          </div>
        </div>
        <div class="custom-temp">
          <h6>설정 온도</h6>
          <div class="input-group">
            <input type="number" class="form-control" id="customTemp" min="16" max="30" step="0.5">
            <span class="input-group-text">°C</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
        <button type="button" class="btn btn-primary" id="saveTemp">저장</button>
      </div>
    </div>
  </div>
</div>

<!-- MQTT 연결 스크립트 -->
<script type="text/javascript">
  let client = null;

  function connectMQTT() {
  const broker = 'ws://파이썬 Server IP:9001';
  const topic = 'cam/objects';

  const client = mqtt.connect(broker);

  client.on("connect", () => {
      console.log("브로커 연결 성공");
      client.subscribe(topic, (err) => {
          if(!err) {
              console.log(`토픽 구독 : ${topic}`);
          }
      });
  });// MQTT Client 실행 함수

  client.on("message", (topic, message) => {
      try{
          const payload = JSON.parse(message.toString());
          const base64Image = payload.image;
          const img = document.getElementById("cameraView")
          img.src = `data:image/jpg;base64,${base64Image}`;

          document.getElementById("resultText").innerText = payload.result || "결과 없음";  // result에 결과 값 표시
      }catch(e) {
          console.error('Failed to parse message: ', e);
      }
  });

  client.on("error", (error) => {
      console.error("연결 오류 : ", error);
  });

  client.on("close", ()=> {
      console.log("브로커와 연결되지 않습니다. 담당자에게 확인하세요.");
  });
  }//  function connectMQTT() END

  function disconnectMQTT() {
  if (client) {
  client.end();
  client = null;
  document.getElementById("cameraView").src = '';
  document.getElementById("resultText").innerText = "스트리밍 중지됨";
  }// if END
  }// function disconnectMQTT() END
</script>

<script th:inline="javascript">
  const pythonServerUrl = 'http://파이썬 Server IP:8080';

    document.addEventListener('DOMContentLoaded', function() {
        const startButton = document.getElementById('startBtn');
        const stopButton = document.getElementById('stopBtn');
        const videoStream = document.getElementById('video-stream');
        const detectedItems = document.getElementById('detected-items');

        const temperatureModal = new bootstrap.Modal(document.getElementById('temperatureModal'));
        const saveTemp = document.getElementById('saveTemp');
        const customTemp = document.getElementById('customTemp');

        let isStreaming = false;

        // Start 버튼 이벤트
        startButton.addEventListener('click', function() {
            startButton.disabled = true;
            stopButton.disabled = false;

            fetch(`${pythonServerUrl}/start`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                connectMQTT();
                startStreaming();
            })
            .catch(error => console.error('startButton 실행 함수에서 에러 발생!!', error));
        });

        // Stop 버튼 이벤트
        stopButton.addEventListener('click', function() {
            startButton.disabled = false;
            stopButton.disabled = true;

            fetch(`${pythonServerUrl}/stop`, {
                method: 'POST'
            })
            .then(() => {
                disconnectMQTT();
            })
            .catch(error => console.error('stopButton 실행 함수에서 에러 발생!!', error));
        });

        function startStreaming() {
            const eventSource = new EventSource('/tf/fashion/stream');

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateDetectedItems(data);

                if (shouldShowModal(data)) {
                    const recommendedTemp = calculateRecommendedTemp(data);
                    document.getElementById('recommendedTemp').textContent = recommendedTemp;
                    customTemp.value = recommendedTemp;
                    temperatureModal.show();
                }
            };

            eventSource.onerror = function() {
                eventSource.close();
            };
        }

        // 온도 저장 버튼 이벤트
        saveTemp.addEventListener('click', function() {
            const temperature = customTemp.value;

            fetch('/tf/temperature/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    temperature: temperature
                })
            })
            .then(response => response.json())
            .then(data => {
                temperatureModal.hide();
                alert('온도가 설정되었습니다.');
            })
            .catch(error => console.error('Error:', error));
        });
    });

  // 모달 표시 여부 결정 함수
  function shouldShowModal(data) {
      // 여기에 모달 표시 조건 구현
      return true;
  }

   // 추천 온도 계산 함수
    function calculateRecommendedTemp(data) {
        // 의류 데이터 기반 온도 계산 로직 구현
        return 20; // 테스트를 위해 20도 반환
    }

    // 탐지된 아이템 업데이트 함수
    function updateDetectedItems(data) {
        const detectedItems = document.getElementById('detected-items');
        detectedItems.innerHTML = ''; // 기존 목록 초기화

        if (Array.isArray(data)) {
            data.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} (신뢰도: ${(item.confidence * 100).toFixed(1)}%)`;
                detectedItems.appendChild(li);
            });
        }
    }
</script>
</body>
</html>